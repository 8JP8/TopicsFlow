{
	"info": {
		"_postman_id": "chatapp-passwordless-api-001",
		"name": "ChatApp API - Passwordless Authentication",
		"description": "Complete API test collection for ChatApp Backend with Passwordless Authentication",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "chatapp-passwordless"
	},
	"variable": [
		{
			"key": "baseUrl",
			"value": "http://localhost:5000",
			"type": "default"
		},
		{
			"key": "userId",
			"value": "",
			"type": "string"
		},
		{
			"key": "email",
			"value": "test@example.com",
			"type": "string"
		},
		{
			"key": "username",
			"value": "testuser",
			"type": "string"
		},
		{
			"key": "verificationCode",
			"value": "",
			"type": "string"
		},
		{
			"key": "totpSecret",
			"value": "",
			"type": "string"
		},
		{
			"key": "originalSecret",
			"value": "",
			"type": "string"
		}
	],
	"item": [
		{
			"name": "Health Check",
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}/health",
					"host": ["{{baseUrl}}"],
					"path": ["health"]
				},
				"description": "Check if the API is running"
			},
			"response": []
		},
		{
			"name": "Passwordless Authentication",
			"item": [
				{
					"name": "1. Register (Passwordless)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    var jsonData = pm.response.json();",
									"    if (jsonData.user_id) {",
									"        pm.collectionVariables.set('userId', jsonData.user_id);",
									"        console.log('User ID saved:', jsonData.user_id);",
									"    }",
									"    pm.test('Registration successful', function() {",
									"        pm.expect(jsonData.success).to.be.true;",
									"    });",
									"} else {",
									"    pm.test('Registration failed', function() {",
									"        pm.expect(pm.response.code).to.equal(201);",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"{{username}}\",\n  \"email\": \"{{email}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/register-passwordless",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "register-passwordless"]
						},
						"description": "Register a new user without password. Only username and email required. Sends verification code to email."
					},
					"response": []
				},
				{
					"name": "2. Verify Email",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    if (jsonData.totp_secret) {",
									"        pm.collectionVariables.set('totpSecret', jsonData.totp_secret);",
									"        pm.collectionVariables.set('originalSecret', jsonData.totp_secret);",
									"        console.log('TOTP Secret saved:', jsonData.totp_secret);",
									"        console.log('QR Code Data:', jsonData.totp_qr_data);",
									"    }",
									"    pm.test('Email verified', function() {",
									"        pm.expect(jsonData.success).to.be.true;",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"user_id\": \"{{userId}}\",\n  \"code\": \"123456\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/verify-email",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "verify-email"]
						},
						"description": "Verify email with 6-digit code. Returns QR code data and TOTP secret for 2FA setup."
					},
					"response": []
				},
				{
					"name": "2a. Resend Verification Code",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"user_id\": \"{{userId}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/resend-verification",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "resend-verification"]
						},
						"description": "Resend email verification code if user didn't receive it."
					},
					"response": []
				},
				{
					"name": "3. Complete TOTP Setup",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    if (jsonData.backup_codes) {",
									"        console.log('Backup Codes:', JSON.stringify(jsonData.backup_codes, null, 2));",
									"    }",
									"    pm.test('TOTP setup complete', function() {",
									"        pm.expect(jsonData.success).to.be.true;",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"user_id\": \"{{userId}}\",\n  \"totp_code\": \"123456\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/complete-totp-setup",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "complete-totp-setup"]
						},
						"description": "Complete TOTP setup by verifying first code from authenticator app. Returns backup codes. Registration complete after this step."
					},
					"response": []
				},
				{
					"name": "4. Login (Passwordless)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    pm.test('Login successful', function() {",
									"        pm.expect(jsonData.success).to.be.true;",
									"        pm.expect(jsonData.user).to.exist;",
									"    });",
									"    console.log('Logged in as:', jsonData.user.username);",
									"} else {",
									"    pm.test('Login failed', function() {",
									"        pm.expect(pm.response.code).to.equal(200);",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"identifier\": \"{{username}}\",\n  \"totp_code\": \"123456\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/login-passwordless",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "login-passwordless"]
						},
						"description": "Login with username/email and TOTP code (no password required). identifier can be either username or email."
					},
					"response": []
				},
				{
					"name": "Get Current User",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/auth/me",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "me"]
						},
						"description": "Get currently authenticated user information"
					},
					"response": []
				},
				{
					"name": "Logout",
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/auth/logout",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "logout"]
						},
						"description": "Logout and clear session"
					},
					"response": []
				}
			],
			"description": "Passwordless authentication flow: Register → Verify Email → Setup 2FA → Login with TOTP"
		},
		{
			"name": "Account Recovery",
			"item": [
				{
					"name": "1. Initiate Recovery",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"{{email}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/recovery/initiate-passwordless",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "recovery", "initiate-passwordless"]
						},
						"description": "Initiate account recovery by sending verification code to email"
					},
					"response": []
				},
				{
					"name": "2. Verify Recovery Code",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    if (jsonData.user_id) {",
									"        pm.collectionVariables.set('userId', jsonData.user_id);",
									"        console.log('User ID for recovery:', jsonData.user_id);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"{{email}}\",\n  \"code\": \"123456\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/recovery/verify-email-code",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "recovery", "verify-email-code"]
						},
						"description": "Verify recovery email code"
					},
					"response": []
				},
				{
					"name": "3. Reset TOTP with Original Secret",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    if (jsonData.totp_secret) {",
									"        pm.collectionVariables.set('totpSecret', jsonData.totp_secret);",
									"        console.log('New TOTP Secret:', jsonData.totp_secret);",
									"        console.log('New QR Code:', jsonData.totp_qr_data);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"user_id\": \"{{userId}}\",\n  \"original_secret\": \"{{originalSecret}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/recovery/reset-totp",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "recovery", "reset-totp"]
						},
						"description": "Reset TOTP using the original secret from initial registration. User must have saved this secret."
					},
					"response": []
				},
				{
					"name": "4. Complete Recovery TOTP Setup",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    if (jsonData.backup_codes) {",
									"        console.log('New Backup Codes:', JSON.stringify(jsonData.backup_codes, null, 2));",
									"    }",
									"    pm.test('Recovery complete', function() {",
									"        pm.expect(jsonData.success).to.be.true;",
									"    });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"user_id\": \"{{userId}}\",\n  \"totp_code\": \"123456\",\n  \"new_secret\": \"{{totpSecret}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/recovery/complete-totp-setup",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "recovery", "complete-totp-setup"]
						},
						"description": "Complete recovery by verifying new TOTP code. Returns new backup codes. User should save new secret."
					},
					"response": []
				}
			],
			"description": "Account recovery flow: Email verification → Enter original secret → Setup new 2FA → Get new backup codes"
		},
		{
			"name": "Legacy Authentication (Password-based)",
			"item": [
				{
					"name": "Register (with Password)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"legacy_user\",\n  \"email\": \"legacy@example.com\",\n  \"password\": \"SecurePass123!\",\n  \"phone\": \"1234567890\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/register",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "register"]
						},
						"description": "Legacy registration with password (for backward compatibility)"
					},
					"response": []
				},
				{
					"name": "Login (with Password)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"legacy_user\",\n  \"password\": \"SecurePass123!\",\n  \"totp_code\": \"123456\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/auth/login",
							"host": ["{{baseUrl}}"],
							"path": ["api", "auth", "login"]
						},
						"description": "Legacy login with password + TOTP (for backward compatibility)"
					},
					"response": []
				}
			],
			"description": "Legacy password-based authentication endpoints (maintained for backward compatibility)"
		}
	]
}
